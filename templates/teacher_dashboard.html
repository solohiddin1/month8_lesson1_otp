<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 5px; }
        h1 { margin-bottom: 10px; color: #2c3e50; }
        h2 { color: #34495e; margin-bottom: 15px; }
        h3 { color: #7f8c8d; margin: 10px 0; }
        .user-info { margin-bottom: 20px; padding: 15px; background: #3498db; color: white; border-radius: 3px; }
        .user-info h3 { margin-bottom: 5px; color: white; }
        .top-actions { margin-bottom: 20px; }
        .top-actions button { margin-right: 10px; padding: 8px 15px; cursor: pointer; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; border-radius: 5px 5px 0 0; }
        .tab.active { background: white; border-bottom: 2px solid white; margin-bottom: -2px; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        button { padding: 5px 10px; cursor: pointer; border: 1px solid #ddd; background: #3498db; color: white; border-radius: 3px; }
        button:hover { background: #2980b9; }
        button.delete { background: #e74c3c; }
        button.delete:hover { background: #c0392b; }
        button.edit { background: #27ae60; margin-right: 5px; }
        button.edit:hover { background: #229954; }
        button.back { background: #95a5a6; margin-bottom: 15px; }
        button.back:hover { background: #7f8c8d; }
        .group-card { background: #ecf0f1; padding: 15px; margin: 10px 0; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .group-card:hover { background: #d5dbdb; transform: translateY(-2px); }
        .group-card h3 { color: #2c3e50; }
        .group-detail { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
        .group-header { background: #3498db; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .lesson-item { background: white; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .lesson-item:hover { background: #f8f9fa; }
        .lesson-item h4 { color: #2980b9; margin-bottom: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: relative; margin: 50px auto; padding: 20px; background: white; width: 90%; max-width: 600px; border-radius: 5px; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 15px; color: #2c3e50; }
        .modal-content label { display: block; margin-top: 10px; font-weight: bold; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .modal-content textarea { min-height: 100px; }
        .modal-actions { margin-top: 20px; display: flex; gap: 10px; }
        .msg { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .msg.error { background: #fadbd8; color: #c0392b; }
        .msg.success { background: #d5f4e6; color: #229954; }
        .profile-card { background: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .profile-card p { margin: 5px 0; }
        .profile-card strong { color: #2c3e50; }
        .student-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 3px; background: white; }
        .student-item { padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 3px; display: flex; align-items: center; }
        .student-item input[type="checkbox"] { margin-right: 10px; }
        .homework-card { background: white; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .homework-card .badge { display: inline-block; padding: 5px 10px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .homework-card .badge.checked { background: #d4edda; color: #155724; }
        .homework-card .badge.unchecked { background: #fff3cd; color: #856404; }
        .empty-state { text-align: center; padding: 40px; color: #95a5a6; }
        .lesson-detail-view { background: #fff; padding: 20px; border-radius: 5px; }
        .media-preview { margin: 10px 0; }
        .media-preview img { max-width: 200px; border-radius: 5px; }
        .media-preview video { max-width: 100%; border-radius: 5px; }
        .attendance-record { background: white; border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teacher Dashboard</h1>
        <div class="user-info">
            <h3 id="teacherName">Loading...</h3>
            <p id="teacherEmail"></p>
        </div>
        
        <div class="top-actions">
            <button id="logoutBtn">Logout</button>
            <button id="changePasswordBtn">Change Password</button>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="profile">My Profile</div>
            <div class="tab" data-tab="groups">My Groups</div>
            <div class="tab" data-tab="homework">Student Homework</div>
        </div>

        <!-- Profile Tab -->
        <div class="tab-content active" id="profile">
            <h2>My Profile</h2>
            <div class="profile-card">
                <p><strong>Name:</strong> <span id="profName">-</span></p>
                <p><strong>Surname:</strong> <span id="profSurname">-</span></p>
                <p><strong>Email:</strong> <span id="profEmail">-</span></p>
                <p><strong>Phone:</strong> <span id="profPhone">-</span></p>
                <p><strong>Age:</strong> <span id="profAge">-</span></p>
            </div>
        </div>

        <!-- Groups Tab -->
        <div class="tab-content" id="groups">
            <div id="groupsListView">
                <h2>My Groups</h2>
                <div id="groupsList"></div>
                <p id="groupsMsg" class="msg" style="display:none;"></p>
            </div>

            <!-- Group Detail View -->
            <div id="groupDetailView" style="display:none;">
                <button class="back" id="backToGroupsBtn">‚Üê Back to Groups</button>
                <div class="group-detail">
                    <div class="group-header">
                        <h2 id="groupDetailName">Group Name</h2>
                        <p id="groupDetailInfo"></p>
                    </div>

                    <!-- Lessons Section -->
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="section-title">üìö Lessons</div>
                            <button id="addLessonBtn">+ Create Lesson</button>
                        </div>
                        <div id="lessonsList"></div>
                        <p id="lessonsMsg" class="msg" style="display:none;"></p>
                    </div>
                </div>
            </div>

            <!-- Lesson Detail View -->
            <div id="lessonDetailView" style="display:none;">
                <button class="back" id="backToLessonsBtn">‚Üê Back to Lessons</button>
                <div class="lesson-detail-view">
                    <div class="group-header">
                        <h2 id="lessonDetailTitle">Lesson Title</h2>
                        <p id="lessonDetailInfo"></p>
                    </div>

                    <!-- Lesson Content Section -->
                    <div class="section">
                        <div class="section-title">üìù Lesson Details</div>
                        <form id="lessonContentForm">
                            <input type="hidden" name="lesson_id">
                            
                            <label>Content:</label>
                            <textarea name="content" placeholder="Enter lesson content..."></textarea>
                            
                            <label>Homework Description:</label>
                            <textarea name="homework_description" placeholder="Enter homework description..."></textarea>
                            
                            <label>Video:</label>
                            <input type="file" name="video" accept="video/*">
                            <div id="videoPreview" class="media-preview"></div>
                            
                            <label>Image:</label>
                            <input type="file" name="image" accept="image/*">
                            <div id="imagePreview" class="media-preview"></div>
                            
                            <p id="lessonContentMsg" class="msg" style="display:none;"></p>
                            <div class="modal-actions">
                                <button type="submit">Save Lesson Details</button>
                            </div>
                        </form>
                    </div>

                    <!-- Attendance Section -->
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="section-title">üìã Mark Attendance</div>
                            <button id="saveAttendanceBtn" style="background: #27ae60;">Save Attendance</button>
                        </div>
                        <p><strong>Mark absent students:</strong></p>
                        <div class="student-list" id="attendanceStudentsList"></div>
                        <p id="attendanceMsg" class="msg" style="display:none;"></p>
                    </div>

                    <!-- Attendance History -->
                    <div class="section">
                        <div class="section-title">üìä Attendance History</div>
                        <div id="attendanceHistory"></div>
                    </div>

                    <!-- Student Homework Submissions -->
                    <div class="section">
                        <div class="section-title">üìÑ Student Homework Submissions</div>
                        <div id="lessonHomeworkList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Homework Tab -->
        <div class="tab-content" id="homework">
            <h2>Student Homework Submissions</h2>
            <div>
                <label><strong>Filter by Group:</strong></label>
                <select id="homeworkGroupFilter" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="">-- All Groups --</option>
                </select>
            </div>
            <div id="homeworkList"></div>
            <p id="homeworkMsg" class="msg" style="display:none;"></p>
        </div>
    </div>

    <!-- Lesson Modal (Create) -->
    <div id="lessonModal" class="modal">
        <div class="modal-content">
            <h3 id="lessonModalTitle">Create New Lesson</h3>
            <form id="lessonForm">
                <input type="hidden" name="lesson_id">
                <input type="hidden" name="group_id">
                
                <label>Title:</label>
                <input type="text" name="title" required>
                
                <label>Start Time:</label>
                <input type="time" name="start_time" required>
                
                <label>End Time:</label>
                <input type="time" name="end_time" required>
                
                <p id="lessonFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Create Lesson</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Homework Grade Modal -->
    <div id="homeworkGradeModal" class="modal">
        <div class="modal-content">
            <h3>Grade Homework</h3>
            <form id="homeworkGradeForm">
                <input type="hidden" name="homework_upload_id">
                
                <div id="homeworkContent"></div>
                
                <label>Mark (Grade):</label>
                <input type="number" name="mark" min="0" max="100" required>
                
                <p id="homeworkGradeFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Save Grade</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>Change Password</h3>
            <form id="passwordForm">
                <label>Email:</label>
                <input type="email" name="email" required>
                
                <label>Old Password:</label>
                <input type="password" name="old_password" required>
                
                <label>New Password:</label>
                <input type="password" name="new_password" required>
                
                <label>Confirm Password:</label>
                <input type="password" name="confirm_password" required>
                
                <p id="passwordFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Change Password</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // JWT Helper Functions
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join('')));
            } catch (e) { return null; }
        }

        function authHeader() {
            const token = localStorage.getItem("accessToken");
            return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
        }

        function showMsg(elementId, message, isError = true) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = message;
            el.className = isError ? "msg error" : "msg success";
            el.style.display = "block";
            setTimeout(() => el.style.display = "none", 5000);
        }

        // Check authentication
        const accessToken = localStorage.getItem("accessToken");
        const refreshToken = localStorage.getItem("refreshToken");

        if (!accessToken) {
            window.location.href = "/login_existing_user/view";
        }

        const payload = parseJwt(accessToken);
        if (!payload) {
            alert("Invalid token!");
            localStorage.clear();
            window.location.href = "/login_existing_user/view";
        }

        const teacherId = payload.user_id;
        let teacherData = null;
        let myGroups = [];
        let currentGroup = null;
        let currentGroupLessons = [];
        let currentGroupStudents = [];
        let currentLesson = null;

        // Tab Navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });

        // Close modals
        document.querySelectorAll('.cancel').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Token refresh
        async function refreshAccessToken() {
            const refresh = localStorage.getItem("refreshToken");
            const res = await fetch("/api/token/refresh/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ refresh }),
            });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem("accessToken", data.access);
                return data.access;
            } else {
                localStorage.clear();
                window.location.href = "/login_existing_user/view";
            }
        }

        async function authorizedFetch(url, options = {}) {
            let res = await fetch(url, {
                ...options,
                headers: { ...authHeader(), ...options.headers },
            });

            if (res.status === 401) {
                const newAccess = await refreshAccessToken();
                res = await fetch(url, {
                    ...options,
                    headers: { ...authHeader(), Authorization: `Bearer ${newAccess}`, ...options.headers },
                });
            }

            return res;
        }

        // ========== FETCH TEACHER PROFILE ==========
        async function fetchMyProfile() {
            try {
                const res = await authorizedFetch("/api/teacher_profile/");
                const data = await res.json();
                
                if (res.ok && data) {
                    teacherData = data;
                    document.getElementById("teacherName").textContent = `${teacherData.name} ${teacherData.surname}`;
                    document.getElementById("teacherEmail").textContent = teacherData.email || payload.email;
                    
                    document.getElementById("profName").textContent = teacherData.name || '-';
                    document.getElementById("profSurname").textContent = teacherData.surname || '-';
                    document.getElementById("profEmail").textContent = teacherData.email || '-';
                    document.getElementById("profPhone").textContent = teacherData.phone_number || '-';
                    document.getElementById("profAge").textContent = teacherData.age || '-';
                }
            } catch (err) {
                console.error("Failed to fetch profile", err);
            }
        }

        // ========== FETCH MY GROUPS ==========
        async function fetchMyGroups() {
            try {
                const res = await authorizedFetch("/api/teacher/groups/");
                const data = await res.json();
                const container = document.getElementById("groupsList");
                container.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    myGroups = data;
                    
                    if (myGroups.length === 0) {
                        container.innerHTML = '<div class="empty-state"><h3>No groups assigned</h3><p>You have no groups assigned yet.</p></div>';
                        return;
                    }
                    
                    myGroups.forEach(g => {
                        const card = document.createElement("div");
                        card.className = "group-card";
                        card.innerHTML = `
                            <h3>${g.name || 'Unnamed Group'}</h3>
                            <p><strong>Description:</strong> ${g.description || 'No description'}</p>
                            <p><strong>Room:</strong> ${g.room || 0} | <strong>Floor:</strong> ${g.floor || 1}</p>
                            <p><strong>Students:</strong> ${g.student_count || 0}</p>
                            <p style="color: ${g.is_active ? 'green' : 'red'}; font-weight: bold;">
                                ${g.is_active ? '‚úì Active' : '‚úó Inactive'}
                            </p>
                        `;
                        card.onclick = () => viewGroupDetail(g.id);
                        container.appendChild(card);
                    });

                    // Populate homework filter
                    const homeworkFilter = document.getElementById("homeworkGroupFilter");
                    homeworkFilter.innerHTML = '<option value="">-- All Groups --</option>';
                    myGroups.forEach(g => {
                        homeworkFilter.innerHTML += `<option value="${g.id}">${g.name}</option>`;
                    });
                } else {
                    showMsg("groupsMsg", "Failed to load groups");
                }
            } catch (err) {
                showMsg("groupsMsg", "Failed to fetch groups");
            }
        }

        // ========== VIEW GROUP DETAIL ==========
        async function viewGroupDetail(groupId) {
            currentGroup = myGroups.find(g => g.id === groupId);
            if (!currentGroup) return;

            document.getElementById("groupsListView").style.display = "none";
            document.getElementById("groupDetailView").style.display = "block";
            document.getElementById("lessonDetailView").style.display = "none";

            document.getElementById("groupDetailName").textContent = currentGroup.name;
            document.getElementById("groupDetailInfo").textContent = 
                `${currentGroup.description || ''} | Room: ${currentGroup.room} | Floor: ${currentGroup.floor} | Students: ${currentGroup.student_count}`;

            await fetchGroupLessons(groupId);
            await fetchGroupStudents(groupId);
        }

        // Back to groups button
        document.getElementById("backToGroupsBtn").addEventListener("click", () => {
            document.getElementById("groupDetailView").style.display = "none";
            document.getElementById("groupsListView").style.display = "block";
            currentGroup = null;
        });

        // Back to lessons button
        document.getElementById("backToLessonsBtn").addEventListener("click", () => {
            document.getElementById("lessonDetailView").style.display = "none";
            document.getElementById("groupDetailView").style.display = "block";
            currentLesson = null;
        });

        // ========== FETCH GROUP LESSONS ==========
        async function fetchGroupLessons(groupId) {
            try {
                const res = await authorizedFetch("/create_lesson/");
                const data = await res.json();
                const container = document.getElementById("lessonsList");
                container.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    currentGroupLessons = data.filter(l => l.group === groupId);
                    
                    if (currentGroupLessons.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No lessons yet. Create one!</p>';
                        return;
                    }
                    
                    currentGroupLessons.forEach(l => {
                        const item = document.createElement("div");
                        item.className = "lesson-item";
                        item.innerHTML = `
                            <h4>${l.title || 'Untitled'}</h4>
                            <p><strong>Time:</strong> ${l.start_time} - ${l.end_time}</p>
                            <p style="color: #7f8c8d; font-size: 12px;">Click to view details</p>
                        `;
                        item.onclick = () => viewLessonDetail(l.id);
                        container.appendChild(item);
                    });
                } else {
                    showMsg("lessonsMsg", "Failed to load lessons");
                }
            } catch (err) {
                showMsg("lessonsMsg", "Failed to fetch lessons");
            }
        }

        // ========== VIEW LESSON DETAIL ==========
        async function viewLessonDetail(lessonId) {
            currentLesson = currentGroupLessons.find(l => l.id === lessonId);
            if (!currentLesson) return;

            document.getElementById("groupDetailView").style.display = "none";
            document.getElementById("lessonDetailView").style.display = "block";

            document.getElementById("lessonDetailTitle").textContent = currentLesson.title;
            document.getElementById("lessonDetailInfo").textContent = 
                `Time: ${currentLesson.start_time} - ${currentLesson.end_time}`;

            // Populate lesson content form
            const form = document.getElementById("lessonContentForm");
            form.lesson_id.value = currentLesson.id;
            form.content.value = currentLesson.content || '';
            form.homework_description.value = currentLesson.homework?.description || '';

            // Show current media
            const videoPreview = document.getElementById("videoPreview");
            const imagePreview = document.getElementById("imagePreview");
            videoPreview.innerHTML = '';
            imagePreview.innerHTML = '';

            if (currentLesson.video_url) {
                videoPreview.innerHTML = `<video src="${currentLesson.video_url}" controls style="max-width: 100%;"></video>`;
            }
            if (currentLesson.image) {
                imagePreview.innerHTML = `<img src="${currentLesson.image}" alt="Lesson Image">`;
            }

            await fetchLessonAttendance(lessonId);
            await fetchLessonHomework(lessonId);
        }

        // ========== FETCH GROUP STUDENTS ==========
        async function fetchGroupStudents(groupId) {
            try {
                const res = await authorizedFetch(`/api/group/${groupId}/students/`);
                const data = await res.json();
                
                if (res.ok && Array.isArray(data)) {
                    currentGroupStudents = data;
                } else {
                    currentGroupStudents = [];
                }
            } catch (err) {
                console.error("Failed to fetch students", err);
                currentGroupStudents = [];
            }
        }

        // ========== POPULATE ATTENDANCE LIST ==========
        function populateAttendanceList() {
            const container = document.getElementById("attendanceStudentsList");
            container.innerHTML = "";
            
            if (currentGroupStudents.length === 0) {
                container.innerHTML = '<p style="color: #999;">No students in this group</p>';
                return;
            }
            
            currentGroupStudents.forEach(student => {
                const item = document.createElement("div");
                item.className = "student-item";
                item.innerHTML = `
                    <input type="checkbox" name="absent_students" value="${student.id}" id="student_${student.id}">
                    <label for="student_${student.id}">${student.name} ${student.surname || ''}</label>
                `;
                container.appendChild(item);
            });
        }

        // ========== FETCH LESSON ATTENDANCE ==========
        async function fetchLessonAttendance(lessonId) {
            try {
                const res = await authorizedFetch("/attendense/");
                const data = await res.json();
                const container = document.getElementById("attendanceHistory");
                container.innerHTML = "";
                
                // Populate students list for marking attendance
                populateAttendanceList();
                
                if (res.ok && Array.isArray(data)) {
                    const lessonAttendance = data.filter(a => a.lesson === lessonId);
                    
                    if (lessonAttendance.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center;">No attendance records yet</p>';
                        return;
                    }
                    
                    lessonAttendance.forEach(a => {
                        const absentCount = Array.isArray(a.absent_students) ? a.absent_students.length : 0;
                        const date = a.created_at ? new Date(a.created_at).toLocaleString() : 'N/A';
                        
                        const item = document.createElement("div");
                        item.className = "attendance-record";
                        item.innerHTML = `
                            <strong>${date}</strong> | Absent: ${absentCount} students
                        `;
                        container.appendChild(item);
                    });
                }
            } catch (err) {
                console.error("Failed to fetch attendance", err);
            }
        }

        // ========== FETCH LESSON HOMEWORK SUBMISSIONS ==========
        async function fetchLessonHomework(lessonId) {
            try {
                const res = await authorizedFetch("/api/homework_get/");
                const data = await res.json();
                const container = document.getElementById("lessonHomeworkList");
                container.innerHTML = "";

                if (res.ok && Array.isArray(data)) {
                    const lessonHomework = data.filter(hw => hw.lesson === lessonId);

                    if (lessonHomework.length === 0) {
                        container.innerHTML = '<p style="color: #999; text-align: center;">No homework submissions yet</p>';
                        return;
                    }

                    lessonHomework.forEach(hw => {
                        const card = document.createElement("div");
                        card.className = "homework-card";
                        
                        const studentName = hw.student?.name || 'Unknown Student';
                        const submittedDate = hw.uploaded_at ? new Date(hw.uploaded_at).toLocaleString() : 'N/A';
                        const badge = hw.is_checked ? 
                            '<span class="badge checked">‚úì Checked</span>' : 
                            '<span class="badge unchecked">‚ö† Not Checked</span>';

                        let contentHTML = '';
                        if (hw.text) contentHTML += `<p><strong>Text:</strong> ${hw.text}</p>`;
                        if (hw.file) contentHTML += `<p><strong>File:</strong> <a href="${hw.file}" target="_blank">Download</a></p>`;
                        if (hw.photo) contentHTML += `<p><strong>Photo:</strong> <a href="${hw.photo}" target="_blank">View</a></p>`;

                        card.innerHTML = `
                            <h4>${studentName}</h4>
                            ${badge}
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            ${contentHTML}
                            <p><strong>Mark:</strong> ${hw.mark !== null && hw.mark !== undefined ? hw.mark : 'Not graded'}</p>
                            <button class="edit gradeHomeworkBtn" data-id="${hw.id}" data-json='${JSON.stringify(hw)}'>Grade / Check</button>
                        `;
                        container.appendChild(card);
                    });
                }
            } catch (err) {
                console.error("Failed to fetch homework", err);
            }
        }

        // ========== CREATE LESSON ==========
        document.getElementById("addLessonBtn").addEventListener("click", () => {
            if (!currentGroup) return;
            const form = document.getElementById("lessonForm");
            form.reset();
            form.lesson_id.value = "";
            form.group_id.value = currentGroup.id;
            document.getElementById("lessonModalTitle").textContent = "Create New Lesson";
            document.getElementById("lessonModal").style.display = "block";
        });

        document.getElementById("lessonForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const payload = {
                title: this.title.value,
                start_time: this.start_time.value,
                end_time: this.end_time.value,
                teacher: teacherId,
                group: parseInt(this.group_id.value)
            };
            
            try {
                const res = await authorizedFetch("/create_lesson/", { 
                    method: "POST", 
                    body: JSON.stringify(payload) 
                });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById("lessonModal").style.display = "none";
                    showMsg("lessonsMsg", "Lesson created successfully!", false);
                    await fetchGroupLessons(currentGroup.id);
                } else {
                    showMsg("lessonFormMsg", JSON.stringify(data));
                }
            } catch (err) {
                showMsg("lessonFormMsg", "Something went wrong");
            }
        });

        // ========== UPDATE LESSON CONTENT ==========
        document.getElementById("lessonContentForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const lessonId = this.lesson_id.value;
            const formData = new FormData();
            
            formData.append('content', this.content.value);
            formData.append('teacher', teacherId);
            formData.append('group', currentLesson.group);
            formData.append('title', currentLesson.title);
            formData.append('start_time', currentLesson.start_time);
            formData.append('end_time', currentLesson.end_time);
            
            // Handle homework description - create or update homework
            if (this.homework_description.value) {
                // If lesson already has homework, we'll update it via separate call
                // Otherwise, create new homework first
                if (currentLesson.homework) {
                    try {
                        const homeworkRes = await authorizedFetch(`/api/homework/${currentLesson.homework.id}/`, {
                            method: "PUT",
                            body: JSON.stringify({ description: this.homework_description.value })
                        });
                    } catch (err) {
                        console.error("Failed to update homework", err);
                    }
                } else {
                    // Create new homework
                    try {
                        const homeworkRes = await authorizedFetch("/api/homework_get/", {
                            method: "POST",
                            body: JSON.stringify({ description: this.homework_description.value })
                        });
                        const homeworkData = await homeworkRes.json();
                        if (homeworkRes.ok) {
                            formData.append('homework', homeworkData.id);
                        }
                    } catch (err) {
                        console.error("Failed to create homework", err);
                    }
                }
            }
            
            // Handle file uploads
            if (this.video.files[0]) {
                formData.append('video_url', this.video.files[0]);
            }
            if (this.image.files[0]) {
                formData.append('image', this.image.files[0]);
            }
            
            try {
                const token = localStorage.getItem("accessToken");
                const res = await fetch(`/lesson_detail/${lessonId}/`, { 
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (res.status === 401) {
                    const newToken = await refreshAccessToken();
                    const retryRes = await fetch(`/lesson_detail/${lessonId}/`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${newToken}`
                        },
                        body: formData
                    });
                    
                    if (retryRes.ok) {
                        showMsg("lessonContentMsg", "Lesson updated successfully!", false);
                        await fetchGroupLessons(currentGroup.id);
                        await viewLessonDetail(lessonId);
                    } else {
                        const data = await retryRes.json();
                        showMsg("lessonContentMsg", JSON.stringify(data));
                    }
                } else if (res.ok) {
                    showMsg("lessonContentMsg", "Lesson updated successfully!", false);
                    await fetchGroupLessons(currentGroup.id);
                    await viewLessonDetail(lessonId);
                } else {
                    const data = await res.json();
                    showMsg("lessonContentMsg", JSON.stringify(data));
                }
            } catch (err) {
                showMsg("lessonContentMsg", "Something went wrong");
            }
        });

        // ========== SAVE ATTENDANCE ==========
        document.getElementById("saveAttendanceBtn").addEventListener("click", async function() {
            if (!currentLesson) return;

            const absentStudents = [];
            document.querySelectorAll('input[name="absent_students"]:checked').forEach(cb => {
                absentStudents.push(parseInt(cb.value));
            });

            const payload = {
                teacher_id: teacherId,
                group_id: currentGroup.id,
                lesson: currentLesson.id,
                absent_students: absentStudents
            };

            try {
                const res = await authorizedFetch("/attendense/", {
                    method: "POST",
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (res.ok) {
                    showMsg("attendanceMsg", "Attendance saved successfully!", false);
                    document.querySelectorAll('input[name="absent_students"]').forEach(cb => cb.checked = false);
                    await fetchLessonAttendance(currentLesson.id);
                } else {
                    showMsg("attendanceMsg", JSON.stringify(data));
                }
            } catch (err) {
                showMsg("attendanceMsg", "Failed to save attendance");
            }
        });

        // ========== FETCH STUDENT HOMEWORK (ALL) ==========
        async function fetchStudentHomework(groupId = null) {
            try {
                const res = await authorizedFetch("/api/homework_get/");
                const data = await res.json();
                const container = document.getElementById("homeworkList");
                container.innerHTML = "";

                if (res.ok && Array.isArray(data)) {
                    let filteredHomework = data;

                    // Filter by group if selected
                    if (groupId) {
                        // First, get all lessons for this group
                        const lessonsRes = await authorizedFetch("/create_lesson/");
                        const lessonsData = await lessonsRes.json();
                        const groupLessonIds = lessonsData.filter(l => l.group === parseInt(groupId)).map(l => l.id);
                        
                        filteredHomework = data.filter(hw => groupLessonIds.includes(hw.lesson));
                    }

                    if (filteredHomework.length === 0) {
                        container.innerHTML = '<div class="empty-state"><h3>No homework submissions</h3><p>No students have submitted homework yet.</p></div>';
                        return;
                    }

                    filteredHomework.forEach(hw => {
                        const card = document.createElement("div");
                        card.className = "homework-card";
                        
                        const studentName = hw.student?.name || 'Unknown Student';
                        const submittedDate = hw.uploaded_at ? new Date(hw.uploaded_at).toLocaleString() : 'N/A';
                        const badge = hw.is_checked ? 
                            '<span class="badge checked">‚úì Checked</span>' : 
                            '<span class="badge unchecked">‚ö† Not Checked</span>';

                        let contentHTML = '';
                        if (hw.text) contentHTML += `<p><strong>Text:</strong> ${hw.text}</p>`;
                        if (hw.file) contentHTML += `<p><strong>File:</strong> <a href="${hw.file}" target="_blank">Download</a></p>`;
                        if (hw.photo) contentHTML += `<p><strong>Photo:</strong> <a href="${hw.photo}" target="_blank">View</a></p>`;

                        card.innerHTML = `
                            <h4>${studentName}</h4>
                            ${badge}
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                            ${contentHTML}
                            <p><strong>Mark:</strong> ${hw.mark !== null && hw.mark !== undefined ? hw.mark : 'Not graded'}</p>
                            <button class="edit gradeHomeworkBtn" data-id="${hw.id}" data-json='${JSON.stringify(hw)}'>Grade / Check</button>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    showMsg("homeworkMsg", "Failed to load homework");
                }
            } catch (err) {
                showMsg("homeworkMsg", "Failed to fetch homework");
            }
        }

        // Homework filter change
        document.getElementById("homeworkGroupFilter").addEventListener("change", function() {
            fetchStudentHomework(this.value);
        });

        // ========== GRADE HOMEWORK ==========
        document.addEventListener("click", function(e) {
            if (e.target.classList.contains("gradeHomeworkBtn")) {
                const hw = JSON.parse(e.target.dataset.json);
                const form = document.getElementById("homeworkGradeForm");
                form.homework_upload_id.value = hw.id;
                form.mark.value = hw.mark || '';

                let contentHTML = '<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">';
                contentHTML += `<p><strong>Student:</strong> ${hw.student?.name || 'Unknown'}</p>`;
                contentHTML += `<p><strong>Status:</strong> ${hw.is_checked ? 'Checked' : 'Not Checked'}</p>`;
                if (hw.text) contentHTML += `<p><strong>Text:</strong> ${hw.text}</p>`;
                if (hw.file) contentHTML += `<p><a href="${hw.file}" target="_blank">View File</a></p>`;
                if (hw.photo) contentHTML += `<p><a href="${hw.photo}" target="_blank">View Photo</a></p>`;
                contentHTML += '</div>';

                document.getElementById("homeworkContent").innerHTML = contentHTML;
                document.getElementById("homeworkGradeModal").style.display = "block";
            }
        });

        document.getElementById("homeworkGradeForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const id = this.homework_upload_id.value;
            const mark = parseInt(this.mark.value);

            try {
                // First, update the mark
                const markRes = await authorizedFetch(`/api/homework_put_mark/${id}/`, {
                    method: "PUT",
                    body: JSON.stringify({ mark: mark })
                });

                if (!markRes.ok) {
                    const data = await markRes.json();
                    showMsg("homeworkGradeFormMsg", JSON.stringify(data));
                    return;
                }

                // Then, check the homework
                const checkRes = await authorizedFetch(`/api/homework_put_mark/${id}/`, {
                    method: "POST",
                    body: JSON.stringify({})
                });

                const checkData = await checkRes.json();

                if (checkRes.ok) {
                    document.getElementById("homeworkGradeModal").style.display = "none";
                    showMsg("homeworkMsg", "Homework graded and checked successfully!", false);
                    
                    // Refresh the appropriate view
                    if (currentLesson) {
                        await fetchLessonHomework(currentLesson.id);
                    }
                    const groupFilter = document.getElementById("homeworkGroupFilter").value;
                    await fetchStudentHomework(groupFilter);
                } else {
                    showMsg("homeworkGradeFormMsg", JSON.stringify(checkData));
                }
            } catch (err) {
                showMsg("homeworkGradeFormMsg", "Failed to grade homework");
            }
        });

        // ========== CHANGE PASSWORD ==========
        document.getElementById("changePasswordBtn").addEventListener("click", () => {
            document.getElementById("passwordForm").reset();
            document.getElementById("passwordForm").email.value = payload.email || "";
            document.getElementById("passwordModal").style.display = "block";
        });

        document.getElementById("passwordForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            if (this.new_password.value !== this.confirm_password.value) {
                showMsg("passwordFormMsg", "Passwords do not match!");
                return;
            }

            const payloadData = {
                email: this.email.value,
                old_password: this.old_password.value,
                new_password: this.new_password.value,
                confirm_password: this.confirm_password.value
            };

            try {
                const res = await authorizedFetch("/api/change_password/", {
                    method: "POST",
                    body: JSON.stringify(payloadData)
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById("passwordModal").style.display = "none";
                    alert("Password changed successfully!");
                } else {
                    showMsg("passwordFormMsg", data.error || JSON.stringify(data));
                }
            } catch (err) {
                showMsg("passwordFormMsg", "Failed to change password");
            }
        });

        // ========== LOGOUT ==========
        document.getElementById("logoutBtn").addEventListener("click", async function() {
            try {
                await fetch("/api/logout/", {
                    method: "POST",
                    headers: authHeader(),
                    body: JSON.stringify({ refresh: refreshToken })
                });
            } catch(e) {
                console.error(e);
            }
            localStorage.clear();
            window.location.href = "/login_existing_user/view";
        });

        // ========== INITIAL DATA LOAD ==========
        async function initializeDashboard() {
            await fetchMyProfile();
            await fetchMyGroups();
            await fetchStudentHomework();
        }

        initializeDashboard();
    </script>
</body>
</html>