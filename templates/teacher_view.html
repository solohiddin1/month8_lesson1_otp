{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block header %}Welcome Admin{% endblock %}

{% block content %}
<p>You are logged in as <span id="adminEmail">{{ request.user.email }}</span></p>

<div style="margin-bottom:20px;">
    <button id="logoutBtn">Logout</button>
    <button id="addTeacherBtn">Add Teacher</button>
</div>

<h3>All Teachers</h3>
<table id="teachersTable" border="1" cellpadding="5">
    <thead>
        <tr>
            <th>Name</th>
            <th>Surname</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Age</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Add/Edit Teacher Modal -->
<div id="teacherModal" style="display:none; border:1px solid #000; padding:20px; background:#f0f0f0;">
    <h4 id="modalTitle">Add Teacher</h4>
    <form id="teacherForm">
        <input type="hidden" name="teacher_id">
        <label>Name:</label>
        <input type="text" name="name" required><br>
        <label>Surname:</label>
        <input type="text" name="surname" required><br>
        <label>Age:</label>
        <input type="number" name="age" min="1" max="100"><br>
        <label>Email:</label>
        <input type="email" name="email" required><br>
        <label>Phone:</label>
        <input type="text" name="phone_number" required pattern="^\+998\d{9}$" title="+998XXXXXXXXX"><br>
        <button type="submit">Save</button>
        <button type="button" id="cancelBtn">Cancel</button>
    </form>
    <p id="teacherMsg" style="color:red;"></p>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Decode JWT payload
function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(decodeURIComponent(atob(base64).split('').map(c => {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join('')));
    } catch (e) { return null; }
}

document.addEventListener("DOMContentLoaded", async function() {
    const accessToken = localStorage.getItem("accessToken");
    const refreshToken = localStorage.getItem("refreshToken");
    if (!accessToken) window.location.href = "/login_existing_user/view";

    const payload = parseJwt(accessToken);
    if (!payload || payload.role !== "admin") {
        alert("You are not authorized as admin!");
        localStorage.removeItem("accessToken");
        localStorage.removeItem("refreshToken");
        window.location.href = "/login_existing_user/view";
        return;
    }

    document.getElementById("adminEmail").innerText = payload.email || "{{ request.user.email }}";

    const tableBody = document.querySelector("#teachersTable tbody");
    const modal = document.getElementById("teacherModal");
    const form = document.getElementById("teacherForm");
    const modalTitle = document.getElementById("modalTitle");
    const teacherMsg = document.getElementById("teacherMsg");

    // Fetch teachers
    async function fetchTeachers() {
        try {
            const res = await fetch("/api/teachers/", { headers: { "Authorization": `Bearer ${accessToken}` }});
            const data = await res.json();
            tableBody.innerHTML = "";
            if (Array.isArray(data)) {
                data.forEach(t => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${t.name}</td>
                        <td>${t.surname}</td>
                        <td>${t.user ? t.user.email : "Email yoq"}</td>
                        <td>${t.user ? t.user.phone_number : "N/A"}</td>
                        <td>${t.age}</td> <!-- show age here -->
                        <td>
                            <button class="editBtn"
                                data-id="${t.id}"
                                data-email="${t.user ? t.user.email : ''}"
                                data-phone="${t.user ? t.user.phone_number : ''}"
                                data-name="${t.name}"
                                data-age="${t.age}"
                                data-surname="${t.surname}">
                                Edit
                            </button>
                            <button class="deleteBtn" data-id="${t.id}">Delete</button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });
            }
        } catch (err) { console.error(err); }
    }

    await fetchTeachers();

    // Add Teacher Button
    document.getElementById("addTeacherBtn").addEventListener("click", () => {
        form.reset();
        form.teacher_id.value = "";
        modalTitle.innerText = "Add Teacher";
        teacherMsg.innerText = "";
        modal.style.display = "block";
    });

    // Cancel modal
    document.getElementById("cancelBtn").addEventListener("click", () => modal.style.display = "none");

    // Save Teacher (create or update)
    form.onsubmit = async function(e) {
        e.preventDefault();
        const id = form.teacher_id.value;
        const payload = {
            name: form.name.value.trim(),
            surname: form.surname.value.trim(),
            age: parseInt(form.age.value, 10),
            user: {
                email: form.email.value.trim(),
                phone_number: form.phone_number.value.trim()
            }
        };
        let url = "/api/teachers/";
        let method = "POST";
        if (id) { 
            url += id + "/"; 
            method = "PUT";
        }
        try {
            const res = await fetch(url, {
                method: method,
                headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                modal.style.display = "none";
                fetchTeachers();
            } else {
                teacherMsg.innerText = JSON.stringify(data);
            }
        } catch (err) { teacherMsg.innerText = "Something went wrong"; }
    };

    // Edit/Delete buttons
    tableBody.addEventListener("click", async function(e) {
        if (e.target.classList.contains("editBtn")) {
            const btn = e.target;
            form.teacher_id.value = btn.dataset.id;
            form.name.value = btn.dataset.name;
            form.surname.value = btn.dataset.surname;
            form.email.value = btn.dataset.email;
            form.phone_number.value = btn.dataset.phone;
            modalTitle.innerText = "Edit Teacher";
            teacherMsg.innerText = "";
            modal.style.display = "block";
        } else if (e.target.classList.contains("deleteBtn")) {
            if (!confirm("Are you sure you want to delete this teacher?")) return;
            const id = e.target.dataset.id;
            try {
                const res = await fetch(`/api/teachers/${id}/`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${accessToken}` }
                });
                if (res.ok) fetchTeachers();
                else alert("Failed to delete");
            } catch (err) { console.error(err); alert("Something went wrong"); }
        }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async function() {
        try {
            await fetch("/api/logout/", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({refresh: refreshToken}) });
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            window.location.href="/login_existing_user/view";
        } catch(e){ console.error(e); }
    });
});
</script>
{% endblock %}
