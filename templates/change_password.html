{% extends "base.html" %}
{% block title %}Change Password{% endblock %}
{% block header %}Change Password{% endblock %}

{% block content %}
    <h2>Change Password</h2>

    <form id="changePasswordForm">
        {% csrf_token %}
        <label>Email:</label>
        <input type="email" id="email" required><br>

        <label>Old Password:</label>
        <input type="password" id="old_password" required><br>

        <label>New Password:</label>
        <input type="password" id="new_password" required><br>

        <label>Confirm Password:</label>
        <input type="password" id="confirm_password" required><br>

        <button type="submit">Change</button>
    </form>

    <p id="message" style="color:red;"></p>

    <script>
        document.getElementById("changePasswordForm").addEventListener("submit", async function(e) {
            e.preventDefault();  // prevent normal form submission

            const email = document.getElementById("email").value;
            const old_password = document.getElementById("old_password").value;
            const new_password = document.getElementById("new_password").value;
            const confirm_password = document.getElementById("confirm_password").value;

            if (new_password !== confirm_password) {
                document.getElementById("message").innerText = "Passwords do not match!";
                return;
            }

            try {
                const response = await fetch("api/change_password/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",  // needed if CSRF enabled
                    },
                    body: JSON.stringify({
                        email: email,
                        old_password: old_password,
                        new_password: new_password,
                        confirm_password: confirm_password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById("message").style.color = "green";
                    document.getElementById("message").innerText = data.message || "Password changed successfully!";

                    // redirect after short delay
                    setTimeout(() => {
                        window.location.href = "/";  // home url
                    }, 1500);
                } else {
                    document.getElementById("message").style.color = "red";
                    document.getElementById("message").innerText = data.error || "Failed to change password.";
                }

            } catch (error) {
                document.getElementById("message").style.color = "red";
                document.getElementById("message").innerText = "Something went wrong!";
            }
        });
    </script>
{% endblock %}
