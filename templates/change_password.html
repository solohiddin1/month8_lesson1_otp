{% extends "base.html" %}
{% block title %}Change Password{% endblock %}
{% block header %}Change Password{% endblock %}

{% block content %}
    <h2>Change Password</h2>

    <form id="changePasswordForm">
        {% csrf_token %}
        <label>Email:</label>
        <input type="email" id="email" required><br>
        <small id="emailError" style="color:red;"></small><br>

        <label>Old Password:</label>
        <input type="password" id="old_password" required><br>
        <small id="oldPasswordError" style="color:red;"></small><br>

        <label>New Password:</label>
        <input type="password" id="new_password" required><br>
        <small id="newPasswordError" style="color:red;"></small><br>

        <label>Confirm Password:</label>
        <input type="password" id="confirm_password" required><br>
        <small id="confirmPasswordError" style="color:red;"></small><br>

        <button type="submit">Change</button>
    </form>

    <p id="message" style="color:red;"></p>

    <script>
        document.getElementById("changePasswordForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            // clear old errors
            document.querySelectorAll("small").forEach(el => el.innerText = "");
            document.querySelectorAll("input").forEach(el => el.style.borderColor = "");

            const email = document.getElementById("email").value;
            const old_password = document.getElementById("old_password").value;
            const new_password = document.getElementById("new_password").value;
            const confirm_password = document.getElementById("confirm_password").value;

            if (new_password !== confirm_password) {
                document.getElementById("confirmPasswordError").innerText = "Passwords do not match!";
                document.getElementById("confirm_password").style.borderColor = "red";
                return;
            }

            try {
                const response = await fetch("/api/change_password/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        email,
                        old_password,
                        new_password,
                        confirm_password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // set tokens
                    localStorage.setItem("accessToken", data.access);
                    localStorage.setItem("refreshToken", data.refresh);

                    document.getElementById("message").style.color = "green";
                    document.getElementById("message").innerText = data.message || "Password changed successfully!";

                    setTimeout(() => window.location.href = "/", 1500);
                } else {
                    document.getElementById("message").style.color = "red";

                    // Handle backend field-specific errors
                    if (data.error) {
                        if (data.error.includes("User matching query does not exist")) {
                            document.getElementById("emailError").innerText = "Email not found!";
                            document.getElementById("email").style.borderColor = "red";
                        }
                        else if (data.error.toLowerCase().includes("incorrect")) {
                            document.getElementById("oldPasswordError").innerText = "Old password is incorrect!";
                            document.getElementById("old_password").style.borderColor = "red";
                        }
                        else {
                            document.getElementById("message").innerText = data.error;
                        }
                    } else if (data.message) {
                        // backend "message" error cases
                        if (data.message.includes("new password should match")) {
                            document.getElementById("confirmPasswordError").innerText = "New and confirm password must match!";
                            document.getElementById("confirm_password").style.borderColor = "red";
                        } else if (data.message.includes("please enter new password")) {
                            document.getElementById("newPasswordError").innerText = "New password cannot be same as old password!";
                            document.getElementById("new_password").style.borderColor = "red";
                        } else {
                            document.getElementById("message").innerText = data.message;
                        }
                    }
                }
            } catch (error) {
                document.getElementById("message").style.color = "red";
                document.getElementById("message").innerText = "Something went wrong!";
            }
        });
    </script>
{% endblock %}
