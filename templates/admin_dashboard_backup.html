<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 5px; }
        h1 { margin-bottom: 10px; }
        .user-info { margin-bottom: 20px; padding: 10px; background: #e9ecef; border-radius: 3px; }
        .top-actions { margin-bottom: 20px; }
        .top-actions button { margin-right: 10px; padding: 8px 15px; cursor: pointer; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; border-radius: 5px 5px 0 0; }
        .tab.active { background: white; border-bottom: 2px solid white; margin-bottom: -2px; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        table th { background: #007bff; color: white; }
        button { padding: 5px 10px; cursor: pointer; border: 1px solid #ddd; background: #007bff; color: white; border-radius: 3px; }
        button:hover { background: #0056b3; }
        button.delete { background: #dc3545; }
        button.delete:hover { background: #c82333; }
        button.edit { background: #28a745; margin-right: 5px; }
        button.edit:hover { background: #218838; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: relative; margin: 50px auto; padding: 20px; background: white; width: 90%; max-width: 500px; border-radius: 5px; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 15px; }
        .modal-content label { display: block; margin-top: 10px; font-weight: bold; }
        .modal-content input, .modal-content textarea, .modal-content select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .modal-content textarea { min-height: 80px; }
        .modal-actions { margin-top: 20px; display: flex; gap: 10px; }
        .msg { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .msg.error { background: #f8d7da; color: #721c24; }
        .msg.success { background: #d4edda; color: #155724; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Dashboard</h1>
        <div class="user-info">
            <p>Logged in as: <strong id="adminEmail"></strong></p>
        </div>
        
        <div class="top-actions">
            <button id="logoutBtn">Logout</button>
            <button id="changePasswordBtn">Change Password</button>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="teachers">Teachers</div>
            <div class="tab" data-tab="students">Students</div>
            <div class="tab" data-tab="user-register">User Register</div>
            <div class="tab" data-tab="groups">Groups</div>
            <div class="tab" data-tab="lessons">Lessons</div>
            <div class="tab" data-tab="attendance">Attendance</div>
        </div>

        <!-- Teachers Tab -->
        <div class="tab-content active" id="teachers">
            <div class="section-header">
                <h2>All Teachers</h2>
                <button id="addTeacherBtn">Add Teacher</button>
            </div>
            <table id="teachersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Surname</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Age</th>
                        <th>Group</th>
                        <th>Lesson</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="teachersMsg" class="msg" style="display:none;"></p>
        </div>

        <!-- Students Tab -->
        <div class="tab-content" id="students">
            <div class="section-header">
                <h2>All Students</h2>
            </div>
            <table id="studentsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Surname</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Age</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="studentsMsg" class="msg" style="display:none;"></p>
        </div>

        <!-- User Register Tab -->
        <div class="tab-content" id="user-register">
            <div class="section-header">
                <h2>Register New User</h2>
            </div>
            <form id="registerForm" style="max-width: 500px;">
                <label>Email:</label>
                <input type="email" name="email" required>
                <label>Phone Number:</label>
                <input type="text" name="phone_number" required pattern="^\+998\d{9}$" title="+998XXXXXXXXX">
                <label>Name:</label>
                <input type="text" name="name" required>
                <label>Surname:</label>
                <input type="text" name="surname" required>
                <label>Age:</label>
                <input type="number" name="age" required min="1" max="100">
                <p id="registerFormMsg" class="msg" style="display:none;"></p>
                <button type="submit" style="margin-top: 15px;">Register User</button>
            </form>
        </div>

        <!-- Groups Tab -->
        <div class="tab-content" id="groups">
            <div class="section-header">
                <h2>All Groups</h2>
                <button id="addGroupBtn">Add Group</button>
            </div>
            <table id="groupsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="groupsMsg" class="msg" style="display:none;"></p>
        </div>

        <!-- Lessons Tab -->
        <div class="tab-content" id="lessons">
            <div class="section-header">
                <h2>All Lessons</h2>
                <button id="addLessonBtn">Add Lesson</button>
            </div>
            <table id="lessonsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="lessonsMsg" class="msg" style="display:none;"></p>
        </div>

        <!-- Attendance Tab -->
        <div class="tab-content" id="attendance">
            <div class="section-header">
                <h2>All Attendance Records</h2>
                <button id="addAttendanceBtn">Add Attendance</button>
            </div>
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Student</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="attendanceMsg" class="msg" style="display:none;"></p>
        </div>
    </div>

    <!-- Teacher Modal -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <h3 id="teacherModalTitle">Add Teacher</h3>
            <form id="teacherForm">
                <input type="hidden" name="teacher_id">
                <label>Name:</label>
                <input type="text" name="name" required>
                <label>Surname:</label>
                <input type="text" name="surname" required>
                <label>Email:</label>
                <input type="email" name="email" required>
                <label>Phone:</label>
                <input type="text" name="phone_number" required pattern="^\+998\d{9}$" title="+998XXXXXXXXX">
                <label>Age:</label>
                <input type="number" name="age" required>
                <label>Group:</label>
                <input type="text" name="group">
                <label>Lesson:</label>
                <input type="text" name="lesson">
                <p id="teacherFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Save</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <h3 id="groupModalTitle">Add Group</h3>
            <form id="groupForm">
                <input type="hidden" name="group_id">
                <label>Name:</label>
                <input type="text" name="name" required>
                <label>Description:</label>
                <textarea name="description"></textarea>
                <p id="groupFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Save</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lesson Modal -->
    <div id="lessonModal" class="modal">
        <div class="modal-content">
            <h3 id="lessonModalTitle">Add Lesson</h3>
            <form id="lessonForm">
                <input type="hidden" name="lesson_id">
                <label>Title:</label>
                <input type="text" name="title" required>
                <label>Description:</label>
                <textarea name="description"></textarea>
                <p id="lessonFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Save</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <h3 id="attendanceModalTitle">Add Attendance</h3>
            <form id="attendanceForm">
                <input type="hidden" name="attendance_id">
                <label>Student ID:</label>
                <input type="number" name="student_id" required>
                <label>Date:</label>
                <input type="date" name="date" required>
                <label>Status:</label>
                <select name="status" required>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="late">Late</option>
                </select>
                <label>Notes:</label>
                <textarea name="notes"></textarea>
                <p id="attendanceFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Save</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>Change Password</h3>
            <form id="passwordForm">
                <label>Old Password:</label>
                <input type="password" name="old_password" required>
                <label>New Password:</label>
                <input type="password" name="new_password" required>
                <label>Confirm Password:</label>
                <input type="password" name="confirm_password" required>
                <p id="passwordFormMsg" class="msg" style="display:none;"></p>
                <div class="modal-actions">
                    <button type="submit">Change Password</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Detail Modal -->
    <div id="groupDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h3 id="groupDetailTitle">Group Details</h3>
            <div id="groupDetailContent">
                <div style="margin-bottom: 20px;">
                    <h4>Group Information</h4>
                    <p><strong>Name:</strong> <span id="groupDetailName"></span></p>
                    <p><strong>Description:</strong> <span id="groupDetailDescription"></span></p>
                    <p><strong>Student Count:</strong> <span id="groupDetailStudentCount"></span></p>
                    <p><strong>Active:</strong> <span id="groupDetailActive"></span></p>
                </div>
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4>Students in this Group</h4>
                        <button id="addStudentToGroupBtn" style="background: #28a745;">Add Student</button>
                    </div>
                    <table id="groupStudentsTable" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Surname</th>
                                <th>Email</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <p id="groupDetailMsg" class="msg" style="display:none;"></p>
            <div class="modal-actions">
                <button type="button" class="cancel">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Student to Group Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Add Student to Group</h3>
            <div style="margin-bottom: 20px;">
                <h4>Available Students</h4>
                <table id="availableStudentsTable" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Email</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <p id="addStudentModalMsg" class="msg" style="display:none;"></p>
            <div class="modal-actions">
                <button type="button" id="confirmAddStudent">Add Selected Student</button>
                <button type="button" class="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // JWT Helper Functions
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join('')));
            } catch (e) { return null; }
        }

        function authHeader() {
            const token = localStorage.getItem("accessToken");
            return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
        }

        function showMsg(elementId, message, isError = true) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = isError ? "msg error" : "msg success";
            el.style.display = "block";
            setTimeout(() => el.style.display = "none", 5000);
        }

        // Check authentication
        const accessToken = localStorage.getItem("accessToken");
        const refreshToken = localStorage.getItem("refreshToken");

        if (!accessToken) {
            window.location.href = "/login_existing_user/view";
        }

        const payload = parseJwt(accessToken);
        if (!payload || payload.role !== "admin") {
            alert("Unauthorized! Admin access only.");
            localStorage.clear();
            window.location.href = "/login_existing_user/view";
        }

        document.getElementById("adminEmail").textContent = payload.email || "Admin";

        // Tab Navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });

        // Close modals
        document.querySelectorAll('.cancel').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // ========== CHANGE PASSWORD ==========
        document.getElementById("changePasswordBtn").addEventListener("click", () => {
            document.getElementById("passwordForm").reset();
            document.getElementById("passwordModal").style.display = "block";
        });

        document.getElementById("passwordForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            if (this.new_password.value !== this.confirm_password.value) {
                showMsg("passwordFormMsg", "Passwords do not match!");
                return;
            }
            
            const payload = {
                old_password: this.old_password.value,
                new_password: this.new_password.value
            };
            
            try {
                const res = await fetch("/api/change_password/", { 
                    method: "POST", 
                    headers: authHeader(), 
                    body: JSON.stringify(payload) 
                });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById("passwordModal").style.display = "none";
                    alert("Password changed successfully!");
                } else {
                    showMsg("passwordFormMsg", data.error || JSON.stringify(data));
                }
            } catch (err) {
                showMsg("passwordFormMsg", "Failed to change password");
            }
        });

        // ========== LOGOUT ==========
        document.getElementById("logoutBtn").addEventListener("click", async function() {
            try {
                await fetch("/api/logout/", { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ refresh: refreshToken }) 
                });
            } catch(e) { 
                console.error(e); 
            }
            localStorage.clear();
            window.location.href = "/login_existing_user/view";
        });

        // ========== INITIAL DATA LOAD ==========
        fetchTeachers();
        fetchStudents();
        fetchGroups();
        fetchLessons();
        fetchAttendance();

        // ========== STUDENTS ==========
        async function fetchStudents() {
            try {
                const res = await fetch("/get_all_students/", { headers: authHeader() });
                const data = await res.json();
                const tbody = document.querySelector("#studentsTable tbody");
                tbody.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    data.forEach(s => {
                        const row = `<tr>
                            <td>${s.id}</td>
                            <td>${s.name || ''}</td>
                            <td>${s.surname || ''}</td>
                            <td>${s.user?.email || 'N/A'}</td>
                            <td>${s.user?.phone_number || 'N/A'}</td>
                            <td>${s.age || 'N/A'}</td>
                            <td>
                                <button class="delete deleteStudentBtn" data-id="${s.user?.id || s.id}">Delete</button>
                            </td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                } else {
                    showMsg("studentsMsg", data.error || "No students found");
                }
            } catch (err) {
                showMsg("studentsMsg", "Failed to fetch students");
            }
        }

        document.querySelector("#studentsTable tbody").addEventListener("click", async function(e) {
            if (e.target.classList.contains("deleteStudentBtn")) {
                if (!confirm("Delete this student?")) return;
                const id = e.target.dataset.id;
                try {
                    const res = await fetch(`/delete_user/${id}/`, { method: "DELETE", headers: authHeader() });
                    if (res.ok) {
                        showMsg("studentsMsg", "Student deleted successfully!", false);
                        fetchStudents();
                    } else {
                        showMsg("studentsMsg", "Failed to delete student");
                    }
                } catch (err) {
                    showMsg("studentsMsg", "Something went wrong");
                }
            }
        });

        // ========== USER REGISTRATION ==========
        document.getElementById("registerForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const payload = {
                user: {
                    email: this.email.value,
                    phone_number: this.phone_number.value
                },
                name: this.name.value,
                surname: this.surname.value,
                age: parseInt(this.age.value)
            };
            
            try {
                const res = await fetch("/register_user/", { 
                    method: "POST", 
                    headers: authHeader(), 
                    body: JSON.stringify(payload) 
                });
                const data = await res.json();
                
                if (res.ok) {
                    showMsg("registerFormMsg", "User registered successfully! Email sent with login details.", false);
                    this.reset();
                    fetchStudents(); // Refresh students list
                } else {
                    showMsg("registerFormMsg", JSON.stringify(data.Error || data));
                }
            } catch (err) {
                showMsg("registerFormMsg", "Something went wrong");
            }
        });

        // ========== GROUP DETAIL FUNCTIONS ==========
        let currentGroupId = null;
        
        async function viewGroupDetail(groupId) {
            currentGroupId = groupId;
            try {
                // Fetch group details
                const groupRes = await fetch(`/create_groups/${groupId}/`, { headers: authHeader() });
                const groupData = await groupRes.json();
                
                if (groupRes.ok) {
                    document.getElementById("groupDetailName").textContent = groupData.name || '';
                    document.getElementById("groupDetailDescription").textContent = groupData.description || '';
                    document.getElementById("groupDetailStudentCount").textContent = groupData.student_count || 0;
                    document.getElementById("groupDetailActive").textContent = groupData.is_active ? 'Yes' : 'No';
                    
                    // Fetch students in this group
                    const studentsRes = await fetch(`/api/group/${groupId}/students/`, { headers: authHeader() });
                    const studentsData = await studentsRes.json();
                    
                    const tbody = document.querySelector("#groupStudentsTable tbody");
                    tbody.innerHTML = "";
                    
                    if (studentsRes.ok && Array.isArray(studentsData)) {
                        studentsData.forEach(s => {
                            const row = `<tr>
                                <td>${s.id}</td>
                                <td>${s.name || ''}</td>
                                <td>${s.surname || ''}</td>
                                <td>${s.user?.email || 'N/A'}</td>
                                <td>${s.age || 'N/A'}</td>
                            </tr>`;
                            tbody.innerHTML += row;
                        });
                    }
                    
                    document.getElementById("groupDetailModal").style.display = "block";
                } else {
                    showMsg("groupsMsg", "Failed to fetch group details");
                }
            } catch (err) {
                showMsg("groupsMsg", "Something went wrong");
            }
        }

        // Add Student to Group Modal
        document.getElementById("addStudentToGroupBtn").addEventListener("click", async function() {
            try {
                // Fetch all available students
                const res = await fetch("/get_all_students/", { headers: authHeader() });
                const data = await res.json();
                const tbody = document.querySelector("#availableStudentsTable tbody");
                tbody.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    data.forEach(s => {
                        const row = `<tr>
                            <td><input type="radio" name="selectedStudent" value="${s.id}"></td>
                            <td>${s.id}</td>
                            <td>${s.name || ''}</td>
                            <td>${s.surname || ''}</td>
                            <td>${s.user?.email || 'N/A'}</td>
                            <td>${s.age || 'N/A'}</td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                }
                
                document.getElementById("addStudentModal").style.display = "block";
            } catch (err) {
                showMsg("groupDetailMsg", "Failed to fetch students");
            }
        });

        // Confirm Add Student to Group
        document.getElementById("confirmAddStudent").addEventListener("click", async function() {
            const selectedStudent = document.querySelector('input[name="selectedStudent"]:checked');
            if (!selectedStudent) {
                showMsg("addStudentModalMsg", "Please select a student");
                return;
            }
            
            const payload = {
                student_id: parseInt(selectedStudent.value),
                group_id: currentGroupId
            };
            
            try {
                const res = await fetch("/add_student_to_group/", {
                    method: "POST",
                    headers: authHeader(),
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById("addStudentModal").style.display = "none";
                    showMsg("groupDetailMsg", "Student added to group successfully!", false);
                    // Refresh group detail
                    viewGroupDetail(currentGroupId);
                    fetchGroups(); // Refresh groups list to update student count
                } else {
                    showMsg("addStudentModalMsg", data.error || "Failed to add student");
                }
            } catch (err) {
                showMsg("addStudentModalMsg", "Something went wrong");
            }
        });

        // ========== TEACHERS ==========
        async function fetchTeachers() {
            try {
                const res = await fetch("/api/teachers/", { headers: authHeader() });
                const data = await res.json();
                const tbody = document.querySelector("#teachersTable tbody");
                tbody.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    data.forEach(t => {
                        const row = `<tr>
                            <td>${t.name || ''}</td>
                            <td>${t.surname || ''}</td>
                            <td>${t.user?.email || 'N/A'}</td>
                            <td>${t.user?.phone_number || 'N/A'}</td>
                            <td>${t.age || 'N/A'}</td>
                            <td>${t.group?.name || 'N/A'}</td>
                            <td>${t.lesson?.title || 'N/A'}</td>
                            <td>
                                <button class="edit editTeacherBtn" data-id="${t.id}" data-json='${JSON.stringify(t)}'>Edit</button>
                                <button class="delete deleteTeacherBtn" data-id="${t.id}">Delete</button>
                            </td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                } else {
                    showMsg("teachersMsg", data.error || "No teachers found");
                }
            } catch (err) {
                showMsg("teachersMsg", "Failed to fetch teachers");
            }
        }

        document.getElementById("addTeacherBtn").addEventListener("click", () => {
            document.getElementById("teacherForm").reset();
            document.getElementById("teacherForm").teacher_id.value = "";
            document.getElementById("teacherModalTitle").textContent = "Add Teacher";
            document.getElementById("teacherModal").style.display = "block";
        });

        document.getElementById("teacherForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const id = this.teacher_id.value;
            const payload = {
                name: this.name.value,
                surname: this.surname.value,
                age: parseInt(this.age.value),
                group: this.group.value ? { name: this.group.value } : null,
                lesson: this.lesson.value ? { title: this.lesson.value } : null,
                user: {
                    email: this.email.value,
                    phone_number: this.phone_number.value
                }
            };
            const url = id ? `/api/teachers/${id}/` : "/api/teachers/";
            const method = id ? "PUT" : "POST";
            
            try {
                const res = await fetch(url, { method, headers: authHeader(), body: JSON.stringify(payload) });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById("teacherModal").style.display = "none";
                    showMsg("teachersMsg", "Teacher saved successfully!", false);
                    fetchTeachers();
                } else {
                    showMsg("teacherFormMsg", JSON.stringify(data));
                }
            } catch (err) {
                showMsg("teacherFormMsg", "Something went wrong");
            }
        });

        document.querySelector("#teachersTable tbody").addEventListener("click", async function(e) {
            if (e.target.classList.contains("editTeacherBtn")) {
                const data = JSON.parse(e.target.dataset.json);
                const form = document.getElementById("teacherForm");
                form.teacher_id.value = data.id;
                form.name.value = data.name || '';
                form.surname.value = data.surname || '';
                form.email.value = data.user?.email || '';
                form.phone_number.value = data.user?.phone_number || '';
                form.age.value = data.age || '';
                form.group.value = data.group?.name || '';
                form.lesson.value = data.lesson?.title || '';
                document.getElementById("teacherModalTitle").textContent = "Edit Teacher";
                document.getElementById("teacherModal").style.display = "block";
            } else if (e.target.classList.contains("deleteTeacherBtn")) {
                if (!confirm("Delete this teacher?")) return;
                const id = e.target.dataset.id;
                try {
                    const res = await fetch(`/api/teachers/${id}/`, { method: "DELETE", headers: authHeader() });
                    if (res.ok) {
                        showMsg("teachersMsg", "Teacher deleted successfully!", false);
                        fetchTeachers();
                    } else {
                        showMsg("teachersMsg", "Failed to delete teacher");
                    }
                } catch (err) {
                    showMsg("teachersMsg", "Something went wrong");
                }
            }
        });

        // ========== GROUPS ==========
        async function fetchGroups() {
            try {
                const res = await fetch("/create_groups/", { headers: authHeader() });
                const data = await res.json();
                const tbody = document.querySelector("#groupsTable tbody");
                tbody.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    data.forEach(g => {
                        const row = `<tr>
                            <td>${g.id}</td>
                            <td>${g.name || ''}</td>
                            <td>${g.description || ''}</td>
                            <td>
                                <button class="edit editGroupBtn" data-id="${g.id}" data-json='${JSON.stringify(g)}'>Edit</button>
                                <button class="delete deleteGroupBtn" data-id="${g.id}">Delete</button>
                                <button class="edit" onclick="viewGroupDetail(${g.id})" style="background: #9b59b6;">View Detail</button>
                            </td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                } else {
                    showMsg("groupsMsg", data.error || "No groups found");
                }
            } catch (err) {
                showMsg("groupsMsg", "Failed to fetch groups");
            }
        }

        document.getElementById("addGroupBtn").addEventListener("click", () => {
            document.getElementById("groupForm").reset();
            document.getElementById("groupForm").group_id.value = "";
            document.getElementById("groupModalTitle").textContent = "Add Group";
            document.getElementById("groupModal").style.display = "block";
        });

        document.getElementById("groupForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const id = this.group_id.value;
            const payload = {
                name: this.name.value,
                description: this.description.value
            };
            const url = id ? `/create_groups/${id}/` : "/cr_gr/";
            const method = id ? "PUT" : "POST";
            
            try {
                const res = await fetch(url, { method, headers: authHeader(), body: JSON.stringify(payload) });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById("groupModal").style.display = "none";
                    showMsg("groupsMsg", "Group saved successfully!", false);
                    fetchGroups();
                } else {
                    showMsg("groupFormMsg", JSON.stringify(data));
                }
            } catch (err) {
                showMsg("groupFormMsg", "Something went wrong");
            }
        });

        document.querySelector("#groupsTable tbody").addEventListener("click", async function(e) {
            if (e.target.classList.contains("editGroupBtn")) {
                const data = JSON.parse(e.target.dataset.json);
                const form = document.getElementById("groupForm");
                form.group_id.value = data.id;
                form.name.value = data.name || '';
                form.description.value = data.description || '';
                document.getElementById("groupModalTitle").textContent = "Edit Group";
                document.getElementById("groupModal").style.display = "block";
            } else if (e.target.classList.contains("deleteGroupBtn")) {
                if (!confirm("Delete this group?")) return;
                const id = e.target.dataset.id;
                try {
                    const res = await fetch(`/create_groups/${id}/`, { method: "DELETE", headers: authHeader() });
                    if (res.ok) {
                        showMsg("groupsMsg", "Group deleted successfully!", false);
                        fetchGroups();
                    } else {
                        showMsg("groupsMsg", "Failed to delete group");
                    }
                } catch (err) {
                    showMsg("groupsMsg", "Something went wrong");
                }
            }
        });

        // ========== LESSONS ==========
        async function fetchLessons() {
            try {
                const res = await fetch("/create_lesson", { headers: authHeader() });
                const data = await res.json();
                const tbody = document.querySelector("#lessonsTable tbody");
                tbody.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    data.forEach(l => {
                        const row = `<tr>
                            <td>${l.id}</td>
                            <td>${l.title || ''}</td>
                            <td>${l.description || ''}</td>
                            <td>
                                <button class="edit editLessonBtn" data-id="${l.id}" data-json='${JSON.stringify(l)}'>Edit</button>
                                <button class="delete deleteLessonBtn" data-id="${l.id}">Delete</button>
                            </td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                } else {
                    showMsg("lessonsMsg", data.error || "No lessons found");
                }
            } catch (err) {
                showMsg("lessonsMsg", "Failed to fetch lessons");
            }
        }

        document.getElementById("addLessonBtn").addEventListener("click", () => {
            document.getElementById("lessonForm").reset();
            document.getElementById("lessonForm").lesson_id.value = "";
            document.getElementById("lessonModalTitle").textContent = "Add Lesson";
            document.getElementById("lessonModal").style.display = "block";
        });

        document.getElementById("lessonForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const id = this.lesson_id.value;
            const payload = {
                title: this.title.value,
                description: this.description.value
            };
            const url = id ? `/lesson_detail/${id}/` : "/create_lesson";
            const method = id ? "PUT" : "POST";
            
            try {
                const res = await fetch(url, { method, headers: authHeader(), body: JSON.stringify(payload) });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById("lessonModal").style.display = "none";
                    showMsg("lessonsMsg", "Lesson saved successfully!", false);
                    fetchLessons();
                } else {
                    showMsg("lessonFormMsg", JSON.stringify(data));
                }
            } catch (err) {
                showMsg("lessonFormMsg", "Something went wrong");
            }
        });

        document.querySelector("#lessonsTable tbody").addEventListener("click", async function(e) {
            if (e.target.classList.contains("editLessonBtn")) {
                const data = JSON.parse(e.target.dataset.json);
                const form = document.getElementById("lessonForm");
                form.lesson_id.value = data.id;
                form.title.value = data.title || '';
                form.description.value = data.description || '';
                document.getElementById("lessonModalTitle").textContent = "Edit Lesson";
                document.getElementById("lessonModal").style.display = "block";
            } else if (e.target.classList.contains("deleteLessonBtn")) {
                if (!confirm("Delete this lesson?")) return;
                const id = e.target.dataset.id;
                try {
                    const res = await fetch(`/lesson_detail/${id}/`, { method: "DELETE", headers: authHeader() });
                    if (res.ok) {
                        showMsg("lessonsMsg", "Lesson deleted successfully!", false);
                        fetchLessons();
                    } else {
                        showMsg("lessonsMsg", "Failed to delete lesson");
                    }
                } catch (err) {
                    showMsg("lessonsMsg", "Something went wrong");
                }
            }
        });

        // ========== ATTENDANCE ==========
        async function fetchAttendance() {
            try {
                const res = await fetch("/attendense/", { headers: authHeader() });
                const data = await res.json();
                const tbody = document.querySelector("#attendanceTable tbody");
                tbody.innerHTML = "";
                
                if (res.ok && Array.isArray(data)) {
                    data.forEach(a => {
                        const row = `<tr>
                            <td>${a.id}</td>
                            <td>${a.student_id || 'N/A'}</td>
                            <td>${a.date || ''}</td>
                            <td>${a.status || ''}</td>
                            <td>${a.notes || ''}</td>
                            <td>
                                <button class="edit editAttendanceBtn" data-id="${a.id}" data-json='${JSON.stringify(a)}'>Edit</button>
                                <button class="delete deleteAttendanceBtn" data-id="${a.id}">Delete</button>
                            </td>
                        </tr>`;
                        tbody.innerHTML += row;
                    });
                } else {
                    showMsg("attendanceMsg", data.error || "No attendance records found");
                }
            } catch (err) {
                showMsg("attendanceMsg", "Failed to fetch attendance");
            }
        }

        document.getElementById("addAttendanceBtn").addEventListener("click", () => {
            document.getElementById("attendanceForm").reset();
            document.getElementById("attendanceForm").attendance_id.value = "";
            document.getElementById("attendanceModalTitle").textContent = "Add Attendance";
            document.getElementById("attendanceModal").style.display = "block";
        });

        document.getElementById("attendanceForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const id = this.attendance_id.value;
            const payload = {
                student_id: parseInt(this.student_id.value),
                date: this.date.value,
                status: this.status.value,
                notes: this.notes.value
            };
            const url = id ? `/attendense/${id}/` : "/attendense/";
            const method = id ? "PUT" : "POST";
            
            try {
                const res = await fetch(url, { method, headers: authHeader(), body: JSON.stringify(payload) });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById("attendanceModal").style.display = "none";
                    showMsg("attendanceMsg", "Attendance saved successfully!", false);
                    fetchAttendance();
                } else {
                    showMsg("attendanceFormMsg", JSON.stringify(data));
                }
            } catch (err) {
                showMsg("attendanceFormMsg", "Something went wrong");
            }
        });

        document.querySelector("#attendanceTable tbody").addEventListener("click", async function(e) {
            if (e.target.classList.contains("editAttendanceBtn")) {
                const data = JSON.parse(e.target.dataset.json);
                const form = document.getElementById("attendanceForm");
                form.attendance_id.value = data.id;
                form.student_id.value = data.student_id || '';
                form.date.value = data.date || '';
                form.status.value = data.status || 'present';
                form.notes.value = data.notes || '';
                document.getElementById("attendanceModalTitle").textContent = "Edit Attendance";
                document.getElementById("attendanceModal").style.display = "block";
            } else if (e.target.classList.contains("deleteAttendanceBtn")) {
                if (!confirm("Delete this attendance record?")) return;
                const id = e.target.dataset.id;
                try {
                    const res = await fetch(`/attendense/${id}/`, { method: "DELETE", headers: authHeader() });
                    if (res.ok) {
                        showMsg("attendanceMsg", "Attendance deleted successfully!", false);
                        fetchAttendance();
                    } else {
                        showMsg("attendanceMsg", "Failed to delete attendance");
                    }
                } catch (err) {
                    showMsg("attendanceMsg", "Something went wrong");
                }
            }
        });
    </script>
</body>
</html>