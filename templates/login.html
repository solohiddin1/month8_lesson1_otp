{% extends "base.html" %}
{% block title %}Login{% endblock %}
{% block header %}Login{% endblock %}

{% block content %}
<h2>Login to Verify Email</h2>

<form id="loginForm">
    {% csrf_token %}
    <label>Email:</label>
    <input type="email" name="email" id="email" placeholder="Enter your email" required><br>

    <label>Password:</label>
    <input type="password" name="password" id="password" placeholder="Enter your password" required><br>

    <button type="submit">Send OTP</button>
</form>

<p id="message" style="color:red; margin-top:10px;"></p>

<script>
document.getElementById("loginForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const messageEl = document.getElementById("message");

    messageEl.style.color = "black";
    messageEl.innerText = "Sending OTP...";

    try {
        const payload = {
            email: email,
            password: password
        };

        const response = await fetch("{% url 'userlogin' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (response.ok && data.success) {
            messageEl.style.color = "green";
            messageEl.innerText = data.message || "OTP sent to your email!";
            
            // Redirect to OTP verification page
            setTimeout(() => {
                window.location.href = "{% url 'verify_user_otp_view' %}";
            }, 1000);
        } else {
            messageEl.style.color = "red";
            messageEl.innerText = data.message || "Invalid credentials.";
        }
    } catch (error) {
        console.error(error);
        messageEl.style.color = "red";
        messageEl.innerText = "Something went wrong!";
    }
});
</script>
{% endblock %}
